<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/research.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>

    <!-- Header Section -->
    <header class="header">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <img src="{{ url_for('static', filename='img/cslogo.png') }}" height="70" class="ms-5">
                <a class="navbar-brand ms-2" href="{{ url_for('homepage') }}">Computer Science Research</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
                    <ul class="navbar-nav mb-2 mb-lg-0 ms-auto">
                        <li class="nav-item me-5">
                            <a href="{{ url_for('homepage') }}" class="active">Home</a>
                        </li>
                        <li class="nav-item me-5">
                            <a href="{{ url_for('research') }}" class="research">Research</a>
                        </li>
                        <li class="nav-item me-5">
                            <a href="https://www.cs.science.cmu.ac.th/" class="aboutus">About us</a>
                        </li>
                        <li class="nav-item me-5">
                            <a href="{{ url_for('contact') }}" class="contact">Contact</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    
    <!-- Projects List Section -->
    <div class="row mt-5" id="projectList">
        <!-- Projects will be dynamically loaded here -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            // ใช้งาน Select2 เพื่อให้ dropdown มี UI ที่ใช้งานง่าย
            $('.select2').select2({
                placeholder: 'Select an option',
                allowClear: true
            });
            // ฟังก์ชันเรียกค้นหาเมื่อกดปุ่ม Enter ในช่องค้นหาหรือ dropdown
            $('#searchKeyword').on('keypress', function (e) {
                if (e.which == 13) {
                    performSearch();
                }
            });

            // ฟังก์ชันเรียกค้นหาเมื่อมีการเปลี่ยนแปลงค่าของ dropdown ใด ๆ
            $('#category, #degree, #type, #instructor, #academicYear').on('change select2:select', function () {
                performSearch(); // เรียก performSearch() เมื่อ dropdown มีการเปลี่ยนแปลงค่า
            });
        });

        function performSearch() {
            // รับค่าจาก dropdown และ input search
            const category = $('#category').val();
            const degree = $('#degree').val();
            const type = $('#type').val();
            const instructor = $('#instructor').val();
            const academicYear = $('#academicYear').val();
            const searchKeyword = $('#searchKeyword').val().trim().toLowerCase();
            console.log(category); // Debug เพื่อเช็คค่าที่ได้รับจาก dropdown

            // ส่งคำขอ AJAX ไปที่ backend เพื่อค้นหาข้อมูลที่ตรงกับฟิลเตอร์และคำค้นหา
            $.ajax({
                url: '/api/projects/search',  // URL สำหรับส่งคำขอค้นหาไปที่ backend API
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    category: category,
                    degree: degree,
                    type: type,
                    instructor: instructor,
                    academicYear: academicYear,
                    keyword: searchKeyword
                }),
                success: function (projects) {
                    // ประมวลผลและแสดงผลโปรเจคที่ค้นพบ
                    const projectList = document.getElementById('projectList');
                    projectList.innerHTML = '';

                    projects.forEach(project => {
                        const projectCard = document.createElement('div');
                        projectCard.classList.add('col-md-6', 'mb-4');

                        projectCard.innerHTML = `
    <div class="project-card border p-3 h-100" onclick="window.location.href='/readresearch/${project.encoded_project_id}';">
        <h3 class="text-center">${project.name}</h3>
        <div class="row fixed-col-size">
            <div class="col-6">
                <p><strong>Category:</strong> ${project.categories}</p>
                <p><strong>Degree:</strong> ${project.degree}</p>
                <p><strong>Type:</strong> ${project.file_types}</p>
                <p><strong>Abstract:</strong> ${project.description.length > 150 ? project.description.substring(0, 150) + "..." : project.description}</p>
            </div>
            <div class="col-6">
                <p><strong>Year:</strong> ${project.year}</p>
                <p><strong>Instructor:</strong> ${project.supervisors}</p>
            </div>
        </div>
    </div>
`;

                        projectList.appendChild(projectCard);
                    });
                },
                error: function (error) {
                    console.error('Error fetching projects:', error);
                }
            });
        }


        function clearSearch() {
            // ล้างค่าฟิลเตอร์และคำค้นหาทั้งหมด
            $('#searchKeyword').val('');
            $('#category').val('').trigger('change');
            $('#degree').val('').trigger('change');
            $('#type').val('').trigger('change');
            $('#instructor').val('').trigger('change');
            $('#academicYear').val('').trigger('change');

            // เรียกฟังก์ชันเพื่อโหลดโปรเจคทั้งหมด
            loadProjects();
        }

        function loadProjects() {
            // เรียกข้อมูลโปรเจคทั้งหมดโดยไม่ใช้ฟิลเตอร์
            $.ajax({
                url: '/api/projects',  // URL สำหรับเรียกข้อมูลโปรเจคทั้งหมด
                method: 'GET',
                success: function (projects) {
                    const projectList = document.getElementById('projectList');
                    projectList.innerHTML = '';

                    projects.forEach(project => {
                        const projectCard = document.createElement('div');
                        projectCard.classList.add('col-md-6', 'mb-4');

                        projectCard.innerHTML = `
                        <div class="project-card border p-3 h-100" onclick="window.location.href='/readresearch/${project.encoded_project_id}';">
                            <h3 class="text-center">${project.name}</h3>
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Category:</strong> ${project.categories}</p>
                                    <p><strong>Degree:</strong> ${project.degree}</p>
                                    <p><strong>Type:</strong> ${project.file_types}</p>
                                    <p><strong>Abstract:</strong> ${project.description}</p>
                                </div>
                                <div class="col-6">
                                    <p><strong>Year:</strong> ${project.year}</p>
                                    <p><strong>Instructor:</strong> ${project.supervisors}</p>
                                </div>
                            </div>
                        </div>
                    `;
                        projectList.appendChild(projectCard);
                    });
                },
                error: function (error) {
                    console.error('Error fetching projects:', error);
                }
            });
        }

        window.onload = loadProjects;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>



</html>